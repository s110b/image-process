name: Compress Images to AVIF

on: [push]

jobs:
  optimize-images:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Setup Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'

    - name: Install Squoosh CLI
      run: npm install @squoosh/cli -g

    - name: Compress Images to AVIF and Log Size
      run: |
        mkdir -p after
        for file in $(find . -type f \( -iname \*.jpg -o -iname \*.jpeg -o -iname \*.png \)); do
          originalSize=$(du -m "$file" | cut -f1)
          squoosh-cli --avif '{"cqLevel":33}' --output "after/$(basename "$file" .${file##*.}).avif" "$file"
          compressedFile="after/$(basename "$file" .${file##*.}).avif"
          if [ -f "$compressedFile" ]; then
            compressedSize=$(du -m "$compressedFile" | cut -f1)
            echo "Original size of $(basename "$file"): ${originalSize}MB, Compressed size: ${compressedSize}MB"
          else
            echo "Error: Compressed file not found - $compressedFile"
          fi
        done

